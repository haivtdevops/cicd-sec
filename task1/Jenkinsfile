pipeline {
    agent any
    environment {
        // Mặc định: block pipeline khi có SAST ERROR, SonarQube quality gate ERROR, hoặc Trivy CRITICAL/HIGH
        SAST_STRICT = 'true'
        SONAR_STRICT = 'true'
        TRIVY_STRICT = 'true'
    }
    options {
        timestamps()
    }

    stages {
        stage('Build (Go)') {
            steps {
                sh '''
                  echo "=== BUILD (GO) STAGE ==="
                  pip install --break-system-packages --no-cache-dir semgrep

                  echo "Go version:"
                  go version || echo "Go not available"

                  cd /workspace/app
                  go mod tidy
                  go build ./...
                '''
            }
        }

        stage('Test (Go)') {
            steps {
                sh '''
                  echo "=== TEST (GO) STAGE ==="
                  cd /workspace/app
                  go test ./...
                '''
            }
        }

        // Quality: SonarQube (code quality, đa ngôn ngữ)
        stage('Quality (SonarQube)') {
            steps {
                sh '''
                  echo "=== SONARQUBE QUALITY STAGE ==="
                  cd /workspace
                  mkdir -p reports

                  if command -v sonar-scanner > /dev/null 2>&1; then
                    # SONAR_HOST_URL và SONAR_TOKEN nên được cấu hình trong môi trường Jenkins job
                    # Hoặc đọc từ file sonar_token.txt (được tạo bởi init-sonar service)
                    : "${SONAR_HOST_URL:=http://sonarqube:9000}"
                    
                    # Đọc token từ file nếu env variable không được set
                    if [ -z "$SONAR_TOKEN" ] && [ -f /workspace/sonar_token.txt ]; then
                      SONAR_TOKEN=$(cat /workspace/sonar_token.txt | tr -d '\n\r ')
                      echo "Using SonarQube token from /workspace/sonar_token.txt"
                    fi
                    
                    if [ -z "$SONAR_TOKEN" ]; then
                      echo "SONAR_TOKEN is not set and sonar_token.txt not found - SonarQube analysis will be skipped."
                    else
                      sonar-scanner \
                        -Dsonar.host.url="$SONAR_HOST_URL" \
                        -Dsonar.login="$SONAR_TOKEN" \
                        -Dsonar.projectBaseDir=/workspace \
                        || echo "Sonar-scanner finished with non-zero exit (will still fetch quality gate if possible)."

                      # Lấy trạng thái quality gate từ SonarQube API và lưu thành JSON
                      curl -fsSL -u "$SONAR_TOKEN:" "$SONAR_HOST_URL/api/qualitygates/project_status?projectKey=demo-multilang" \
                        -o reports/sonarqube_qualitygate.json || echo "Failed to fetch SonarQube quality gate JSON."

                      if [ -f reports/sonarqube_qualitygate.json ]; then
                        python ci/evaluate_sonar.py --input reports/sonarqube_qualitygate.json
                      else
                        echo "SonarQube quality gate JSON not found, skipping evaluation."
                      fi
                    fi
                  else
                    echo "sonar-scanner CLI not installed in Jenkins image - skipping SonarQube scan (demo)."
                  fi
                '''
            }
        }

        // Security: SAST Semgrep
        stage('Security (Semgrep)') {
            steps {
                sh '''
                  echo "=== SEMGREP SAST STAGE ==="
                  cd /workspace
                  mkdir -p reports

                  # Đảm bảo PATH nhìn thấy semgrep (pip cài vào ~/.local/bin)
                  export PATH="$HOME/.local/bin:$PATH"

                  echo "Semgrep version (nếu có):"
                  semgrep --version || echo "semgrep CLI not available"

                  # Chạy Semgrep CLI, luôn sinh JSON nếu chạy thành công
                  semgrep \
                    --config ${SEMGREP_CONFIG:-.semgrep/go.yml} \
                    --json \
                    --output reports/semgrep.json \
                    --error || true

                  if [ -f reports/semgrep.json ]; then
                    python ci/evaluate_semgrep.py --input reports/semgrep.json
                  else
                    echo "Semgrep report not found, skipping evaluation script."
                  fi
                '''
            }
        }

        stage('Docker Build Image') {
            steps {
                sh '''
                  echo "=== DOCKER BUILD IMAGE ==="
                  if command -v docker > /dev/null 2>&1; then
                    docker build -f /workspace/app/Dockerfile -t demo-app:${BUILD_NUMBER} /workspace/app
                  else
                    echo "docker CLI not installed inside Jenkins container - skipping Docker build in this demo"
                  fi
                '''
            }
        }

        stage('Image Scan (Trivy)') {
            steps {
                sh '''
                  echo "=== IMAGE SCAN (TRIVY) ==="
                  cd /workspace
                  mkdir -p reports

                  if command -v trivy > /dev/null 2>&1; then
                    # Kiểm tra image có tồn tại không
                    if docker image inspect demo-app:${BUILD_NUMBER} > /dev/null 2>&1; then
                      # Chạy Trivy scan image và sinh JSON report
                      trivy image \
                        --format json \
                        --output reports/trivy.json \
                        --exit-code 0 \
                        demo-app:${BUILD_NUMBER} || echo "Trivy scan finished (may have findings)."

                      if [ -f reports/trivy.json ]; then
                        python ci/evaluate_trivy.py --input reports/trivy.json
                      else
                        echo "Trivy JSON report not found, skipping evaluation."
                      fi
                    else
                      echo "Docker image demo-app:${BUILD_NUMBER} not found - skipping Trivy scan"
                    fi
                  else
                    echo "Trivy not installed in Jenkins image - skipping image scan"
                  fi
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'reports/**', allowEmptyArchive: true
        }
        failure {
            echo "Pipeline FAILED – vui lòng xem lại log Build/Test/Security."
        }
        success {
            echo "Pipeline PASSED – SAST không có lỗi blocking (ERROR)."
        }
    }
}